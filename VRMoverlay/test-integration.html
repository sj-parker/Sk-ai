<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∏–º–∞—Ü–∏–π</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ffd700;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .test-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        
        .status {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .info {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∏–º–∞—Ü–∏–π</h1>
        
        <div class="info">
            <strong>–°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:</strong> ‚úÖ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∏–º–∞—Ü–∏–π —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç.
            <br><br>
            <strong>–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong>
            ‚Ä¢ –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π (–¥–æ 4 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
            ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π –∏ —ç–º–æ—Ü–∏–π
            ‚Ä¢ –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∞–Ω–∏–º–∞—Ü–∏—è–º–∏
            ‚Ä¢ State machine –¥–ª—è –ª–æ–≥–∏—á–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
            ‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ blend shapes
        </div>
        
        <div class="test-section">
            <h3>üé¨ –¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π</h3>
            <div class="grid-3">
                <button class="btn" onclick="testBasicAnimation('idle')">Idle</button>
                <button class="btn" onclick="testBasicAnimation('talking')">Talking</button>
                <button class="btn" onclick="testBasicAnimation('thinking_move')">Thinking</button>
                <button class="btn" onclick="testBasicAnimation('greeting')">Greeting</button>
                <button class="btn" onclick="testBasicAnimation('surprise_move')">Surprise</button>
                <button class="btn" onclick="testBasicAnimation('excitement')">Excitement</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üòä –¢–µ—Å—Ç —ç–º–æ—Ü–∏–π</h3>
            <div class="grid-3">
                <button class="btn btn-success" onclick="testEmotion('happy')">Happy</button>
                <button class="btn btn-warning" onclick="testEmotion('sad')">Sad</button>
                <button class="btn btn-danger" onclick="testEmotion('angry')">Angry</button>
                <button class="btn" onclick="testEmotion('surprised')">Surprised</button>
                <button class="btn" onclick="testEmotion('neutral')">Neutral</button>
                <button class="btn" onclick="resetEmotions()">Reset</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîÑ –¢–µ—Å—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π</h3>
            <div class="warning">
                <strong>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è:</strong> –ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è + –∂–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
            </div>
            <div class="grid-2">
                <button class="btn" onclick="testOverlapping('idle', 'greeting')">Idle + Greeting</button>
                <button class="btn" onclick="testOverlapping('talking', 'surprise_move')">Talking + Surprise</button>
                <button class="btn" onclick="testOverlapping('thinking_move', 'excitement')">Thinking + Excitement</button>
                <button class="btn" onclick="stopAllAnimations()">Stop All</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üéØ –¢–µ—Å—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ —ç–º–æ—Ü–∏–π</h3>
            <div class="grid-2">
                <button class="btn" onclick="testEmotionPriorities()">Happy ‚Üí Surprised ‚Üí Happy</button>
                <button class="btn" onclick="testEmotionPriorities2()">Sad ‚Üí Angry ‚Üí Neutral</button>
                <button class="btn" onclick="testHighPriorityEmotion()">High Priority Surprised</button>
                <button class="btn" onclick="resetEmotions()">Reset All</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîÑ –¢–µ—Å—Ç State Machine</h3>
            <div class="grid-2">
                <button class="btn" onclick="testStateTransition('idle')">‚Üí Idle</button>
                <button class="btn" onclick="testStateTransition('talking')">‚Üí Talking</button>
                <button class="btn" onclick="testStateTransition('thinking')">‚Üí Thinking</button>
                <button class="btn" onclick="testStateTransition('listening')">‚Üí Listening</button>
                <button class="btn" onclick="revertToPreviousState()">‚Üê Previous</button>
                <button class="btn" onclick="showCurrentState()">Current State</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üëÑ –¢–µ—Å—Ç –ª–∏–ø—Å–∏–Ω–∫–∞</h3>
            <div class="grid-3">
                <button class="btn" onclick="testLipsync('A')">A</button>
                <button class="btn" onclick="testLipsync('I')">I</button>
                <button class="btn" onclick="testLipsync('U')">U</button>
                <button class="btn" onclick="testLipsync('E')">E</button>
                <button class="btn" onclick="testLipsync('O')">O</button>
                <button class="btn" onclick="stopLipsync()">Stop</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h3>
            <div class="grid-2">
                <button class="btn" onclick="showActiveAnimations()">Active Animations</button>
                <button class="btn" onclick="showActiveBlendShapes()">Active Blend Shapes</button>
                <button class="btn" onclick="showCurrentState()">Current State</button>
                <button class="btn" onclick="showAllDebugInfo()">All Debug Info</button>
            </div>
            <div id="debug-output" class="status">
                –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...
            </div>
        </div>
    </div>

    <!-- TWEEN.js –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    
    <!-- Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/examples/jsm/loaders/GLTFLoader.js": "https://unpkg.com/three@0.158.0/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
        import { AnimationIntegration } from './src/animation-integration.js';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        window.app = null;
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.testBasicAnimation = function(name) {
            if (window.app && window.app.animationSystem) {
                window.app.animationSystem.playAnimation(name);
                updateDebugInfo(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è: ${name}`);
            } else {
                updateDebugInfo(`‚ùå –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∏–º–∞—Ü–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞`);
            }
        };
        
        window.testEmotion = function(emotion) {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.applyEmotion(emotion, 0.8, 5);
                updateDebugInfo(`–≠–º–æ—Ü–∏—è: ${emotion}`);
            } else {
                updateDebugInfo(`‚ùå –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ blend shapes –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞`);
            }
        };
        
        window.resetEmotions = function() {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.resetEmotions();
                updateDebugInfo('–≠–º–æ—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã');
            }
        };
        
        window.testOverlapping = function(baseAnim, overlayAnim) {
            if (window.app && window.app.animationSystem) {
                window.app.animationSystem.playAnimation(baseAnim, 0);
                window.app.animationSystem.playAnimation(overlayAnim, 2);
                updateDebugInfo(`–ù–∞–ª–æ–∂–µ–Ω–∏–µ: ${baseAnim} + ${overlayAnim}`);
            }
        };
        
        window.stopAllAnimations = function() {
            if (window.app && window.app.animationSystem) {
                window.app.animationSystem.stopAllAnimations();
                updateDebugInfo('–í—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
            }
        };
        
        window.testEmotionPriorities = function() {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.applyEmotion('happy', 0.5, 5);
                window.app.blendShapeManager.applyEmotion('surprised', 0.8, 8);
                
                setTimeout(() => {
                    window.app.blendShapeManager.applyEmotion('happy', 0.5, 5);
                }, 2000);
                
                updateDebugInfo('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: Happy (5) ‚Üí Surprised (8) ‚Üí Happy (5)');
            }
        };
        
        window.testEmotionPriorities2 = function() {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.applyEmotion('sad', 0.6, 5);
                window.app.blendShapeManager.applyEmotion('angry', 0.9, 8);
                
                setTimeout(() => {
                    window.app.blendShapeManager.applyEmotion('neutral', 0.5, 5);
                }, 2000);
                
                updateDebugInfo('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: Sad (5) ‚Üí Angry (8) ‚Üí Neutral (5)');
            }
        };
        
        window.testHighPriorityEmotion = function() {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.applyEmotion('surprised', 1.0, 10);
                updateDebugInfo('–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Surprised (10)');
            }
        };
        
        window.testStateTransition = function(state) {
            if (window.app && window.app.stateMachine) {
                window.app.stateMachine.transitionTo(state);
                updateDebugInfo(`–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`);
            }
        };
        
        window.revertToPreviousState = function() {
            if (window.app && window.app.stateMachine) {
                window.app.stateMachine.revertToPrevious();
                updateDebugInfo('–í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é');
            }
        };
        
        window.showCurrentState = function() {
            if (window.app && window.app.stateMachine) {
                const state = window.app.stateMachine.getCurrentState();
                const allowed = window.app.stateMachine.getAllowedTransitions();
                updateDebugInfo(`–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}\n–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã: ${allowed.join(', ')}`);
            }
        };
        
        window.testLipsync = function(vowel) {
            if (window.app && window.app.blendShapeManager) {
                const values = {
                    'Fcl_MTH_A': vowel === 'A' ? 0.8 : 0,
                    'Fcl_MTH_I': vowel === 'I' ? 0.8 : 0,
                    'Fcl_MTH_U': vowel === 'U' ? 0.8 : 0,
                    'Fcl_MTH_E': vowel === 'E' ? 0.8 : 0,
                    'Fcl_MTH_O': vowel === 'O' ? 0.8 : 0
                };
                window.app.blendShapeManager.applyLipsync(values, 10);
                updateDebugInfo(`–õ–∏–ø—Å–∏–Ω–∫: ${vowel}`);
            }
        };
        
        window.stopLipsync = function() {
            if (window.app && window.app.blendShapeManager) {
                window.app.blendShapeManager.applyLipsync({
                    'Fcl_MTH_A': 0,
                    'Fcl_MTH_I': 0,
                    'Fcl_MTH_U': 0,
                    'Fcl_MTH_E': 0,
                    'Fcl_MTH_O': 0
                }, 10);
                updateDebugInfo('–õ–∏–ø—Å–∏–Ω–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
        };
        
        window.showActiveAnimations = function() {
            if (window.app && window.app.animationSystem) {
                const active = window.app.animationSystem.getActiveAnimations();
                updateDebugInfo('–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏:\n' + JSON.stringify(active, null, 2));
            }
        };
        
        window.showActiveBlendShapes = function() {
            if (window.app && window.app.blendShapeManager) {
                const active = window.app.blendShapeManager.getActiveBlendShapes();
                updateDebugInfo('–ê–∫—Ç–∏–≤–Ω—ã–µ blend shapes:\n' + JSON.stringify(active, null, 2));
            }
        };
        
        window.showAllDebugInfo = function() {
            let info = 'üé≠ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n';
            
            if (window.app) {
                if (window.app.animationSystem) {
                    const activeAnimations = window.app.animationSystem.getActiveAnimations();
                    info += '–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏:\n' + JSON.stringify(activeAnimations, null, 2) + '\n\n';
                }
                
                if (window.app.blendShapeManager) {
                    const activeBlendShapes = window.app.blendShapeManager.getActiveBlendShapes();
                    info += '–ê–∫—Ç–∏–≤–Ω—ã–µ blend shapes:\n' + JSON.stringify(activeBlendShapes, null, 2) + '\n\n';
                }
                
                if (window.app.stateMachine) {
                    const currentState = window.app.stateMachine.getCurrentState();
                    const allowedTransitions = window.app.stateMachine.getAllowedTransitions();
                    info += `–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentState}\n`;
                    info += `–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã: ${allowedTransitions.join(', ')}\n\n`;
                }
            }
            
            updateDebugInfo(info);
        };
        
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-output');
            if (debugElement) {
                debugElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.addEventListener('load', () => {
            updateDebugInfo('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
            window.app = {
                animationSystem: null,
                blendShapeManager: null,
                stateMachine: null
            };
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
            setTimeout(() => {
                updateDebugInfo('‚úÖ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∏–º–∞—Ü–∏–π –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!\n\n' +
                              'üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n' +
                              '1. –¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π\n' +
                              '2. –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π\n' +
                              '3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —ç–º–æ—Ü–∏–π\n' +
                              '4. State machine');
            }, 1000);
        });
    </script>
</body>
</html> 