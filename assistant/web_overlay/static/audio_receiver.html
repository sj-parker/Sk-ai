<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Receiver for OBS</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            margin: 20px;
            overflow: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .status {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .status.connected {
            background: #2d5a2d;
            border-left: 4px solid #4CAF50;
        }
        
        .status.disconnected {
            background: #5a2d2d;
            border-left: 4px solid #f44336;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .volume-control input {
            width: 200px;
        }
        
        .audio-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .hidden {
            display: none;
        }
        
        .auto-connect {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            cursor: pointer;
        }
        
        .auto-connect:hover {
            background: #45a049;
        }
        
        .obs-instructions {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
        }
        
        .obs-instructions h3 {
            margin-top: 0;
            color: #007acc;
        }
        
        .obs-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .obs-instructions li {
            margin: 5px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
        }
        
        .status-indicator.disconnected {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .debug-info {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Audio Receiver for OBS</h1>
        
        <div class="status disconnected" id="status">
            <span class="status-indicator disconnected" id="status-indicator"></span>
            –°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª—é—á–µ–Ω
        </div>
        
        <div class="auto-connect" onclick="autoConnect()" id="auto-connect">
            üîó –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        </div>
        
        <div class="controls">
            <button onclick="connectAudio()" id="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é</button>
            <button onclick="disconnectAudio()" id="disconnect-btn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button onclick="testAudio()" id="test-btn" disabled>–¢–µ—Å—Ç –∑–≤—É–∫–∞</button>
        </div>
        
        <div class="volume-control">
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.7">
            <span id="volume-value">70%</span>
        </div>
        
        <div class="audio-info" id="audio-info">
            <div>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <span id="client-count">0</span></div>
            <div>–ü–æ–ª—É—á–µ–Ω–æ –∞—É–¥–∏–æ –ø–∞–∫–µ—Ç–æ–≤: <span id="packet-count">0</span></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞–∫–µ—Ç: <span id="last-packet">-</span></div>
            <div>–†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞–∫–µ—Ç–∞: <span id="last-packet-size">-</span></div>
        </div>
        
        <div class="obs-instructions">
            <h3>üì∫ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è OBS:</h3>
            <ol>
                <li>–ù–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" –≤—ã—à–µ</li>
                <li>–í OBS –¥–æ–±–∞–≤—å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ "–ë—Ä–∞—É–∑–µ—Ä"</li>
                <li>–£–∫–∞–∂–∏—Ç–µ URL —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã: <code id="current-url"></code></li>
                <li>–í–∫–ª—é—á–∏—Ç–µ "–ó–≤—É–∫ –±—Ä–∞—É–∑–µ—Ä–∞" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞</li>
                <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ OBS –º–∏–∫—à–µ—Ä–µ</li>
                <li>–ê—É–¥–∏–æ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è</li>
            </ol>
        </div>
        
        <div class="debug-info" id="debug-info">
            <div>WebSocket URL: <span id="ws-url">-</span></div>
            <div>–ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: <span id="audio-context-status">–ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span></div>
        </div>
    </div>

    <script>
        let ws = null;
        let audioContext = null;
        let audioQueue = [];
        let packetCount = 0;
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = null;
        
        const status = document.getElementById('status');
        const statusIndicator = document.getElementById('status-indicator');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const testBtn = document.getElementById('test-btn');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volume-value');
        const clientCount = document.getElementById('client-count');
        const packetCountSpan = document.getElementById('packet-count');
        const lastPacket = document.getElementById('last-packet');
        const lastPacketSize = document.getElementById('last-packet-size');
        const currentUrl = document.getElementById('current-url');
        const wsUrl = document.getElementById('ws-url');
        const audioContextStatus = document.getElementById('audio-context-status');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π URL
        currentUrl.textContent = window.location.href;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        volumeSlider.addEventListener('input', function() {
            volumeValue.textContent = Math.round(this.value * 100) + '%';
        });
        
        // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function autoConnect() {
            const serverIP = window.location.hostname;
            connectToServer(serverIP);
        }
        
        async function connectAudio() {
            if (isConnected) return;
            
            const serverIP = prompt('–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:', window.location.hostname);
            if (!serverIP) return;
            
            connectToServer(serverIP);
        }
        
        async function connectToServer(serverIP) {
            if (isConnected) return;
            
            try {
                status.textContent = '–°—Ç–∞—Ç—É—Å: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                status.className = 'status';
                connectBtn.disabled = true;
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                const wsUrlString = `ws://${serverIP}:31995`;
                wsUrl.textContent = wsUrlString;
                ws = new WebSocket(wsUrlString);
                
                ws.onopen = () => {
                    isConnected = true;
                    reconnectAttempts = 0;
                    status.textContent = '–°—Ç–∞—Ç—É—Å: –ü–æ–¥–∫–ª—é—á–µ–Ω';
                    status.className = 'status connected';
                    statusIndicator.className = 'status-indicator connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    testBtn.disabled = false;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Web Audio API
                    initAudioContext();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    sendPing();
                    
                    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };
                
                ws.onmessage = async (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'audio') {
                            await handleAudioData(data);
                        } else if (data.type === 'pong') {
                            console.log('–ü–æ–ª—É—á–µ–Ω pong –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                ws.onclose = () => {
                    isConnected = false;
                    status.textContent = '–°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª—é—á–µ–Ω';
                    status.className = 'status disconnected';
                    statusIndicator.className = 'status-indicator disconnected';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    testBtn.disabled = true;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        status.textContent = `–°—Ç–∞—Ç—É—Å: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (${reconnectAttempts}/${maxReconnectAttempts})`;
                        setTimeout(() => connectToServer(serverIP), 2000);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                    status.textContent = '–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                    status.className = 'status disconnected';
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                status.textContent = '–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
            }
        }
        
        function disconnectAudio() {
            if (ws) {
                ws.close();
                ws = null;
            }
            isConnected = false;
            reconnectAttempts = maxReconnectAttempts; // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        }
        
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'ping',
                    timestamp: Date.now()
                }));
            }
        }
        
        async function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContextStatus.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
                console.log('Web Audio API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                audioContextStatus.textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Web Audio API:', error);
            }
        }
        
        async function handleAudioData(data) {
            try {
                packetCount++;
                packetCountSpan.textContent = packetCount;
                lastPacket.textContent = new Date().toLocaleTimeString();
                lastPacketSize.textContent = `${Math.round(data.data.length / 1024)} KB`;
                
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –∞—É–¥–∏–æ
                const audioData = atob(data.data);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }
                
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º WAV
                const audioBuffer = await audioContext.decodeAudioData(audioArray.buffer);
                
                // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                
                source.buffer = audioBuffer;
                gainNode.gain.value = volumeSlider.value;
                
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                source.start();
                
                console.log(`üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –∞—É–¥–∏–æ –ø–∞–∫–µ—Ç #${packetCount}`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ:', error);
            }
        }
        
        function testAudio() {
            if (!audioContext) {
                alert('–ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
            gainNode.gain.setValueAtTime(volumeSlider.value * 0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            console.log('üîä –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω');
        }
        
        // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        setTimeout(() => {
            autoConnect();
        }, 1000);
    </script>
</body>
</html> 