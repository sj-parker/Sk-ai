# VRM Overlay для OBS

Этот модуль позволяет использовать 3D модели персонажей в формате VRM для создания красивого оверлея в OBS.

## Возможности

- ✅ Загрузка VRM моделей
- ✅ Анимации состояний (idle, talking, waiting)
- ✅ Эмоции через morph targets
- ✅ Липсинк на основе аудио (в продвинутой версии)
- ✅ Управление камерой
- ✅ WebSocket интеграция с основным приложением
- ✅ Прозрачный фон для OBS

## Установка и настройка

### 1. Подготовка VRM модели

1. Поместите вашу VRM модель в папку `web_overlay/static/models/`
2. Обновите путь к модели в `config.yaml`:

```yaml
VRM_OVERLAY:
  model_path: '/static/models/your_model.vrm'
```

### 2. Настройка конфигурации

В файле `config.yaml` настройте параметры VRM оверлея:

```yaml
VRM_OVERLAY:
  model_path: '/static/models/character.vrm'  # Путь к VRM модели
  model_scale: 1.0  # Масштаб модели
  camera_distance: 2.0  # Расстояние камеры
  model_position:  # Позиция модели
    x: 0
    y: -1
    z: 0
  # Настройки анимаций
  animations:
    idle:
      enabled: true
      weight: 1.0
    talking:
      enabled: true
      weight: 1.0
    waiting:
      enabled: true
      weight: 1.0
  # Настройки эмоций (morph targets)
  emotions:
    happy:
      morph_target: 'happy'
      weight: 1.0
    sad:
      morph_target: 'sad'
      weight: 1.0
    angry:
      morph_target: 'angry'
      weight: 1.0
    surprised:
      morph_target: 'surprised'
      weight: 1.0
```

### 3. Запуск веб-сервера

```bash
python web_overlay/web_server.py
```

## Использование в OBS

### Базовый VRM оверлей

1. В OBS добавьте новый источник "Браузер"
2. URL: `http://localhost:5000/vrm`
3. Ширина: 1920, Высота: 1080
4. Включите "Обновлять браузер при активации сцены"

### Продвинутый VRM оверлей (с липсинком)

1. В OBS добавьте новый источник "Браузер"
2. URL: `http://localhost:5000/vrm-advanced`
3. Ширина: 1920, Высота: 1080
4. Включите "Обновлять браузер при активации сцены"

## Управление

### WebSocket команды

Оверлей автоматически подключается к WebSocket серверу и реагирует на команды:

- `start` - переключение в режим "говорит"
- `stop` - возврат в режим "ожидания"
- `waiting` - режим "нетерпеливого ожидания"
- `emotion:happy` - показать эмоцию "счастливый"
- `emotion:sad` - показать эмоцию "грустный"
- `emotion:angry` - показать эмоцию "злой"
- `emotion:surprised` - показать эмоцию "удивленный"

### Ручное управление

В продвинутой версии доступны кнопки управления:
- Переключение анимаций (Idle, Talking, Waiting)
- Эмоции (Happy, Sad, Angry, Surprised)
- Управление камерой (Reset, Auto Rotate)

## Требования к VRM модели

### Рекомендуемые morph targets

Для полной функциональности эмоций модель должна содержать следующие morph targets:
- `A` - открытие рта (для липсинка)
- `happy` - счастливое выражение
- `sad` - грустное выражение
- `angry` - злое выражение
- `surprised` - удивленное выражение

### Рекомендуемая структура костей

Модель должна содержать стандартные кости VRM:
- `Head` - голова (для анимаций)
- `LeftUpperArm`, `RightUpperArm` - руки (для жестов)

## Устранение неполадок

### Модель не загружается

1. Проверьте путь к файлу в `config.yaml`
2. Убедитесь, что файл имеет расширение `.vrm`
3. Проверьте консоль браузера на ошибки

### Анимации не работают

1. Убедитесь, что модель содержит необходимые кости
2. Проверьте, что morph targets названы правильно
3. Попробуйте базовую версию оверлея

### Липсинк не работает

1. Разрешите доступ к микрофону в браузере
2. Убедитесь, что используется продвинутая версия оверлея
3. Проверьте, что модель содержит morph target `A`

### Проблемы с производительностью

1. Уменьшите масштаб модели в конфигурации
2. Отключите авто-поворот камеры
3. Закройте другие вкладки браузера

## Примеры использования

### Простой оверлей

```yaml
VRM_OVERLAY:
  model_path: '/static/models/simple_character.vrm'
  model_scale: 0.8
  camera_distance: 1.5
```

### Оверлей с эмоциями

```yaml
VRM_OVERLAY:
  model_path: '/static/models/emotional_character.vrm'
  model_scale: 1.0
  camera_distance: 2.0
  emotions:
    happy:
      morph_target: 'Joy'
      weight: 1.0
    sad:
      morph_target: 'Sorrow'
      weight: 1.0
```

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера (F12)
2. Убедитесь, что все зависимости загружены
3. Проверьте настройки WebSocket соединения
4. Убедитесь, что VRM модель соответствует стандарту

## Совместимость

- ✅ Chrome/Chromium
- ✅ Firefox
- ✅ Edge
- ✅ Safari (частично)

## Лицензия

Этот модуль использует:
- Three.js (MIT)
- three-vrm (MIT)
- VRM стандарт (MIT) 